# ArgoCD-Driven Application Vision

## Core Concept

**Config Hub is an ArgoCD-driven GitOps UI** where ArgoCD ApplicationSets are the source of truth, and all configuration management flows through Git PRs.

## Architecture Flow

```
┌─────────────────────────────────────────────────────────────┐
│                     ArgoCD Server                            │
│  ┌──────────────────────────────────────────────────────┐   │
│  │         ApplicationSet Controller                     │   │
│  │  Generates → App1, App2, App3, ... AppN             │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
                    Config Hub discovers
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      Config Hub UI                           │
│                                                              │
│  For each ArgoCD Application:                               │
│  ├─ Auto-discover Git source(s)                            │
│  ├─ Auto-configure Git credentials                         │
│  ├─ Provide editing flows:                                 │
│  │  ├─ Config Values (values.yaml, config files)          │
│  │  ├─ Secrets (Kubernetes Secrets)                       │
│  │  └─ External Secrets (Vault integration)               │
│  └─ All changes → Git PR                                   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
                            ↓
                    All flows result in
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    Pull Request                              │
│  ├─ Config changes                                          │
│  ├─ Secret changes                                          │
│  ├─ External Secret references                              │
│  └─ Review → Merge → ArgoCD syncs                          │
└─────────────────────────────────────────────────────────────┘
```

## Key Principles

### 1. ArgoCD as Source of Truth
- **Discovery**: Config Hub discovers applications from ArgoCD
- **No Manual Config**: Don't manually configure apps - they come from ArgoCD
- **ApplicationSet Driven**: Support apps generated by ApplicationSets
- **Multi-Source**: Handle apps with multiple Git sources

### 2. Git-Centric Workflow
- **Everything via PR**: All changes go through Pull Requests
- **No Direct Apply**: Never apply changes directly to cluster
- **GitOps Compliance**: Maintain full audit trail
- **Review Process**: Changes must be reviewed before merge

### 3. Unified Editing Flows

#### Flow A: Configuration Values
```
User → Browse App → Edit Config → Preview Changes → Create PR
                                                        ↓
                                              Review → Merge → ArgoCD Syncs
```

#### Flow B: Secrets Management
```
User → Browse App → Edit Secret → Encrypt/Store → Create PR
                                                      ↓
                                            Review → Merge → ArgoCD Syncs
```

#### Flow C: External Secrets (Vault)
```
User → Browse App → Configure External Secret → Update Vault → Create PR
                                                                   ↓
                                                         Review → Merge → ArgoCD Syncs
```

## Detailed Workflows

### Configuration Values Flow

```typescript
interface ConfigEditFlow {
  // 1. Discovery
  discoverFromArgoCD: () => {
    application: ArgoCDApplication
    gitSources: GitSource[]  // Can be multiple!
    configFiles: ConfigFile[]
  }
  
  // 2. Editing
  editConfig: (file: ConfigFile) => {
    // Smart editor based on file type
    // - YAML editor for values.yaml
    // - JSON editor for config.json
    // - Text editor for others
    // - Syntax validation
    // - Schema validation (if available)
  }
  
  // 3. Preview
  previewChanges: () => {
    diff: string
    affectedResources: K8sResource[]
    validationResults: ValidationResult[]
  }
  
  // 4. PR Creation
  createPR: () => {
    branch: string
    title: string
    description: string  // Auto-generated with change summary
    reviewers: string[]
  }
}
```

### Secrets Management Flow

```typescript
interface SecretEditFlow {
  // 1. Discovery
  discoverSecrets: () => {
    secrets: K8sSecret[]
    externalSecrets: ExternalSecret[]
    vaultPaths: VaultPath[]
  }
  
  // 2. Editing Options
  editSecret: (secret: K8sSecret) => {
    // Option A: Direct Secret (encrypted in Git)
    encryptValue: (value: string) => string  // Using sealed-secrets or SOPS
    
    // Option B: External Secret (reference to Vault)
    createVaultReference: (vaultPath: string) => ExternalSecretSpec
  }
  
  // 3. Vault Integration
  vaultOperations: {
    // Store secret in Vault
    storeInVault: (path: string, value: string) => void
    
    // Create External Secret manifest
    createExternalSecret: (spec: ExternalSecretSpec) => string
    
    // Validate Vault access
    validateVaultPath: (path: string) => boolean
  }
  
  // 4. PR Creation
  createPR: () => {
    // PR includes:
    // - Secret manifest (encrypted or external secret ref)
    // - Vault path documentation
    // - Security review checklist
  }
}
```

### External Secrets Flow

```typescript
interface ExternalSecretFlow {
  // 1. Vault Setup
  configureVault: () => {
    vaultConnection: VaultConnection
    mountPath: string
    secretPath: string
  }
  
  // 2. Secret Mapping
  mapSecrets: () => {
    // Map Vault secrets to K8s secret keys
    mapping: {
      vaultKey: string
      k8sKey: string
      transformation?: string
    }[]
  }
  
  // 3. External Secret Manifest
  generateManifest: () => {
    apiVersion: "external-secrets.io/v1beta1"
    kind: "ExternalSecret"
    spec: {
      secretStoreRef: VaultSecretStore
      target: K8sSecret
      data: SecretMapping[]
    }
  }
  
  // 4. Dual Operation
  createExternalSecret: () => {
    // Step 1: Store in Vault
    vaultClient.write(path, data)
    
    // Step 2: Create External Secret manifest
    manifest = generateManifest()
    
    // Step 3: Create PR with manifest
    createPR(manifest)
  }
}
```

## UI Structure

### Main Navigation
```
┌─────────────────────────────────────────────────────────────┐
│  Config Hub                                    [Sync ArgoCD] │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  📱 Applications (from ArgoCD)                               │
│  ├─ 🟢 platform-infrastructure-dev                          │
│  ├─ 🟢 platform-infrastructure-prod                         │
│  ├─ 🟢 api-gateway-dev                                      │
│  └─ 🟡 legacy-app-dev (needs attention)                     │
│                                                              │
│  🔧 Settings                                                 │
│  ├─ ArgoCD Connections                                      │
│  ├─ Git Credentials (auto-configured)                       │
│  └─ Vault Connections                                       │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Application Detail View
```
┌─────────────────────────────────────────────────────────────┐
│  platform-infrastructure-dev                    [Sync] [⋮]   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  📊 Status                                                   │
│  ├─ Sync: ✅ Synced (2 minutes ago)                         │
│  ├─ Health: ✅ Healthy                                      │
│  └─ Git: abc123 - "Update config" (main)                   │
│                                                              │
│  📁 Configuration                                            │
│  ├─ values.yaml                    [Edit] [History]         │
│  ├─ config/app.yaml               [Edit] [History]         │
│  └─ config/database.yaml          [Edit] [History]         │
│                                                              │
│  🔐 Secrets                                                  │
│  ├─ api-keys (External Secret → Vault)  [Edit]             │
│  ├─ database-password (Sealed Secret)   [Edit]             │
│  └─ tls-cert (K8s Secret)               [Edit]             │
│                                                              │
│  🔄 Pull Requests                                            │
│  ├─ #123 Update API timeout (Open)                         │
│  └─ #122 Add new feature flag (Merged)                     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Config Editor
```
┌─────────────────────────────────────────────────────────────┐
│  Edit: values.yaml                          [Cancel] [Save]  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────┬────────────────────────────┐   │
│  │ Editor                 │ Preview                     │   │
│  ├────────────────────────┼────────────────────────────┤   │
│  │ replicaCount: 3        │ Changes:                    │   │
│  │ image:                 │ + replicaCount: 2 → 3       │   │
│  │   repository: nginx    │ + resources.limits.memory   │   │
│  │   tag: "1.21"          │                             │   │
│  │ resources:             │ Affected Resources:         │   │
│  │   limits:              │ • Deployment/app            │   │
│  │     memory: 512Mi      │ • HPA/app-hpa               │   │
│  │     cpu: 500m          │                             │   │
│  │                        │ Validation: ✅ Valid        │   │
│  └────────────────────────┴────────────────────────────┘   │
│                                                              │
│  [Create Pull Request]                                       │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Secret Editor
```
┌─────────────────────────────────────────────────────────────┐
│  Edit Secret: api-keys                      [Cancel] [Save]  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Secret Type: [External Secret ▼]                           │
│                                                              │
│  ┌─ Vault Configuration ─────────────────────────────────┐  │
│  │ Vault Path: secret/data/platform/api-keys            │  │
│  │ Mount Path: secret                                    │  │
│  │ Connection: ✅ Connected                              │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                              │
│  ┌─ Secret Mapping ──────────────────────────────────────┐  │
│  │ Vault Key          → K8s Key                          │  │
│  │ ├─ stripe_key      → STRIPE_API_KEY                  │  │
│  │ ├─ sendgrid_key    → SENDGRID_API_KEY                │  │
│  │ └─ jwt_secret      → JWT_SECRET                       │  │
│  │                                                        │  │
│  │ [+ Add Mapping]                                       │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                              │
│  ┌─ Actions ─────────────────────────────────────────────┐  │
│  │ ☐ Store values in Vault now                          │  │
│  │ ☑ Create External Secret manifest                    │  │
│  │ ☑ Create Pull Request                                │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                              │
│  [Save & Create PR]                                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## Implementation Phases

### Phase 1: ArgoCD Discovery ✅ (Partially Done)
- [x] Connect to ArgoCD
- [x] List applications
- [x] Get application details
- [ ] Auto-discover Git sources from app spec
- [ ] Handle multi-source applications
- [ ] Support ApplicationSets

### Phase 2: Git Integration ✅ (Done)
- [x] Git credential management
- [x] Browse repository files
- [x] Create branches
- [x] Create commits
- [x] Create Pull Requests
- [x] View PR diffs
- [x] Approve and merge PRs

### Phase 3: Config Editing (In Progress)
- [x] Parameter editor (basic)
- [ ] YAML editor with validation
- [ ] Preview changes
- [ ] Diff view
- [ ] Auto-generate PR descriptions

### Phase 4: Secrets Management (TODO)
- [ ] Discover secrets in application
- [ ] Sealed Secrets support
- [ ] SOPS support
- [ ] Secret editor UI

### Phase 5: External Secrets + Vault (TODO)
- [ ] Vault connection management
- [ ] External Secret discovery
- [ ] Secret mapping UI
- [ ] Dual operation (Vault + Git PR)
- [ ] Vault path validation

### Phase 6: Unified Experience (TODO)
- [ ] Auto-configure Git from ArgoCD app
- [ ] Smart credential matching
- [ ] Application-centric navigation
- [ ] Unified status dashboard

## Key Technical Decisions

### 1. ArgoCD as Primary Source
```typescript
// On app startup or refresh
async function syncFromArgoCD() {
  const apps = await argocd.listApplications()
  
  for (const app of apps) {
    // Extract Git sources
    const gitSources = extractGitSources(app.spec.sources)
    
    // Auto-configure or match Git credentials
    for (const source of gitSources) {
      const credential = await findOrCreateGitCredential(source.repoURL)
      
      // Link app to credential
      linkApplicationToCredential(app.name, credential.id)
    }
  }
}
```

### 2. Multi-Source Support
```typescript
interface ArgoCDApplication {
  spec: {
    // Single source (legacy)
    source?: GitSource
    
    // Multi-source (new)
    sources?: GitSource[]
  }
}

// Handle both patterns
function getGitSources(app: ArgoCDApplication): GitSource[] {
  if (app.spec.sources) {
    return app.spec.sources.filter(s => s.repoURL)
  }
  if (app.spec.source) {
    return [app.spec.source]
  }
  return []
}
```

### 3. Secret Type Detection
```typescript
function detectSecretType(manifest: any): SecretType {
  if (manifest.kind === 'ExternalSecret') {
    return 'external-secret'
  }
  if (manifest.kind === 'SealedSecret') {
    return 'sealed-secret'
  }
  if (manifest.kind === 'Secret' && manifest.metadata?.annotations?.['sops']) {
    return 'sops-secret'
  }
  return 'kubernetes-secret'
}
```

## Success Metrics

1. **Zero Manual Git Config**: All Git credentials auto-configured from ArgoCD
2. **PR-First**: 100% of changes go through PRs
3. **Secrets Coverage**: Support all secret types (K8s, Sealed, SOPS, External)
4. **Vault Integration**: Seamless Vault + Git workflow
5. **User Efficiency**: Edit → PR in < 5 clicks

## Next Steps

1. **Commit current work** ✅
2. **Brainstorm refinements** (now)
3. **Implement ArgoCD auto-discovery**
4. **Build unified application view**
5. **Add secrets management**
6. **Integrate Vault + External Secrets**

This is the complete vision - an ArgoCD-driven GitOps UI where everything flows naturally from your ApplicationSets!
